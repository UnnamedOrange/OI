[TOC]

# 吉司机线段树

#### 区间最值操作问题

&emsp;&emsp;什么叫做区间最值操作？一般，我们对线段树的操作无非就是单点加，区间加这种简单玩意儿。区间最值操作指：对于一个序列 $A$， 给出三个数 $l$，$r$，$x$，对所有的 $i \in [l, r]$，把 $A_i$ 变成 $\max(A_i, x)$ 或者 $\min(A_i, x)$。这时以前的线段树就挂掉了。

##### 1. e.g. [Gorgeous Sequence](http://acm.hdu.edu.cn/showproblem.php?pid=5306)

###### 题目大意

&emsp;&emsp;给出一个长度为 $n$ 的数组 $A$，有 $m$ 次操作，操作分为三种：询问区间最大值，询问区间最大和，将一个区间内的数全部对参数 $x$ 取 $\min$。$n, m \le 10^6$。

###### Naive

&emsp;&emsp;曾经一度，有一个带有区间取模操作的线段树，那时我们只需要保存一下整个序列的最大值，如果需要操作暴力更新就好了，**因为每次被修改的数的大小至少减小一半，所以最多操作 $O(n \log n)$ 次**。这里我们也试着保存一个最大值，当无需操作时直接退出，否则继续递归。

&emsp;&emsp;遗憾的是，这么做时间复杂度是得不到保证的，**因为不能保证每次更新所有数至少减少一半，所以操作次数是没有上限的**，时间复杂度将会被卡成 $O(mn \log n)$。

###### 吉司机来了

&emsp;&emsp;考虑另外一种解法：对线段树中的每一个结点除了维护 $\mathrm{sum}$ 以外，还要额外维护区间中的最大值 $\mathrm{major}$，**严格次大值 $\mathrm{minor}$**，以及**最大值个数 $t$**。

&emsp;&emsp;修改时，我们不像之前那样，分成需要暴力修改，不需要暴力修改两种情况，而是分成三种情况：

1. 当 $\mathrm{major} \le x$ 时，显然直接退出就好了。
2. 当 $\mathrm{minor} < x < \mathrm{major}$ 时，显然这次修改只会影响到所有的最大值，所以我们可以直接把 $\mathrm{sum}$ 加上 $t \cdot (x - \mathrm{major})$，再把 $\mathrm{major}$ 更新为 $x$，打上懒惰标记后退出即可。 
3. 当 $x \le \mathrm{minor}$ 时，我们无法直接更新这个结点的信息，因此我们暴力递归下去。

&emsp;&emsp;~~然后你就超时了。~~额，超时其实是输入输出优化的问题，你用 `fread`，然后你就过掉了。

------

&emsp;&emsp;为什么这么做就特别快呢？难道不是 $O(mn \log n)$ 的吗？吉司机告诉你，可以证明，这个算法的**均摊时间复杂度为 $O(m \log n)$**。

> 证明
>
> 